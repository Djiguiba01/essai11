<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="../BonCommande/bonOcommande.css">

     <!-- ::::PDF::::::::: -->
     <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.0/jspdf.umd.min.js"></script>
     <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.3.2/html2canvas.min.js"></script>
     
      <!-- <script src="../Pdf/jspdf.umd.min.js"></script> -->
    
</head>
<body>


    <!-- Structure de la nouvelle page pour les détails de la commande -->
    <div  id="capture" class="telechargerpdf">
    <div class="container">
        <header>
            <div class="logo">
                <img src="../images/logo1.png" alt="GROUPE SANKORE Logo">
            </div>
            <div class="header-text">
                <p style="color: red;">Infrastructures - Développement</p>
                <p style="text-align: center;">BTP - Agriculture</p>
                <p style="color: red;">Informatique - Commerce Général</p>
                <p style="text-align: center;">Mobilier - Immobilier</p>
            </div>
        </header>
        
        <section class="delivery-info">
            <div class="gauchedat" style="padding-top: 8%;">
                <p id="dateCommandDetail" style="border: 2px solid black; padding: 5px;"></p>
                <p id="numBonCommandDetail" style="border: 2px solid black; padding: 5px;"></p>
            </div>
            <div class="doitedat" style="border: 2px solid black; padding: 5px; width: 30%;">
                <p id="doitCommandDetail"></p>
                <p id="addresCommandDetail"></p>
            </div>
        </section>
        
        <section class="table-section">
            <table>
                <thead>
                    <tr>
                        <th style="text-align: center; background-color: rgb(167, 167, 228);">Désignation</th>
                        <th style="text-align: center; background-color: rgb(167, 167, 228);">Qté</th>
                        <th style="text-align: center; background-color: rgb(167, 167, 228);">Unité</th>
                        <th style="text-align: center; background-color: rgb(167, 167, 228);">Observations</th>
                    </tr>
                </thead>
                <tbody id="temporaryCommandsDetail">
                    <!-- Les détails des articles seront ajoutés ici -->
                </tbody>
            </table>
        </section>

        <!-- <div class="accordrecept" style="display: flex;justify-content: space-between;">
            <div class="daucheacord">
                POUR Récéption
            </div>
            <div class="droitaccord">
                LE Fournisseur
            </div>
        </div> -->
        <!-- :::::::::::::::::::::::::::::::::::::: -->
        <!-- <footer>
            <p style="color: blue;"><strong style="color: red;">Direction Generale: </strong> Bamako-Mali- Hamdallaye ACI 2000 Immeuble ABK-6 B103</p>
            <p>Tél: +223 76 02 34 71 6 66 02 34 71 - 61 96 17 94 - 20 74 04 48 / E-mail: sankoreservices@gmail.com</p>
            <p>www.sankoreservices.com - sankoreservices@yahoo.fr </p>
            <p style="color: blue;"><strong style="color: red;">Bureau de Mopti-Sévaré:</strong>
                Socoura en face de l'IFP de Sévaré</p>
                <p style="color: blue;">
                    Tél: +223 91 00 00 47 - 91 00 00 48 - 20 29 17 14 - 21 42 19 17
                </p>
                <p style="color: red;"><strong style="color: rgb(15, 146, 85);">Bureau de Tombouctou:</strong>
                    Sareikeina Albamé-Derrière la Mairie de Tbt-tel: 66 69 55 92
                </p>

                <p style="color: blue;"><strong style="color: red;">Bureau de Gao:</strong>
                    Aldjanabandia-4ème Quartier à coté de la Mare - Tél: 76 18 43 97
                </p>
                <p style="color: blue;"> <strong style="font-weight: bold;">NINA:</strong>
                42009194223006T - <strong style="font-weight: bold;">RCCM:</strong> MA.BKO. 2020.B B5. DU 03/01/2020 - <strong>NIF:</strong>082247104J</p>
            </footer> -->
    
    
        </div>
</div>
    


<!-- Fenêtre modale pour l'édition -->
<!-- Fenêtre modale pour l'édition -->
<div id="editModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5);">
    <div style="background-color: white; margin: 10% auto; padding: 20px; width: 80%; max-width: 500px; border-radius: 8px; position: relative;">
        <!-- Icône de fermeture en haut à droite -->
        <span onclick="closeModal()" style="position: absolute; top: 10px; right: 10px; font-size: 24px; cursor: pointer;">&times;</span>
        
        <h3>Modifier la commande</h3>
        <label for="editDesignation">Désignation :</label>
        <input type="text" id="editDesignation" />

        <label for="editQuantity">Quantité :</label>
        <input type="text" id="editQuantity" />

        <label for="editUnit">Unité :</label>
        <input type="text" id="editUnit" />

        <label for="editDoit">Doit :</label>
        <input type="text" id="editDoit" />

        <label for="editAddress">Adresse :</label>
        <input type="text" id="editAddress" />

        <label for="editNumBon">Numéro de bon :</label>
        <input type="text" id="editNumBon" />

        <button onclick="saveChanges()">Enregistrer</button>
        <!-- Nouveau bouton pour supprimer -->
        <button onclick="confirmDelete()" style="background-color: red; color: white; margin-top: 10px;">Supprimer</button>
    </div>
</div>


<!-- Fenêtre modale de confirmation de suppression -->
<div id="confirmDeleteModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5);">
    <div style="background-color: white; margin: 20% auto; padding: 20px; width: 80%; max-width: 400px; border-radius: 8px; text-align: center;">
        <p>Êtes-vous sûr de vouloir supprimer cette ligne ?</p>
        <button onclick="deleteRow()" style="background-color: red; color: white; margin-right: 10px;">Confirmer</button>
        <button onclick="closeConfirmDeleteModal()">Annuler</button>
    </div>
</div>


<!-- Bouton flottant -->
<button class="telechargerpdf" style="margin: auto;" onclick="makePDF()"><i class="fas fa-download"></i> Télécharger</button>
<!-- <button onclick="makePDF()" style="position: absolute; right: 130px;">
    Télécharger PDF
</button>  -->


</body>
</html>



<script>
 // Fonction pour récupérer les paramètres de l'URL
function getParameterByName(name) {
    const url = new URL(window.location.href);
    return url.searchParams.get(name);
}

// Récupérer l'ID de la commande sélectionnée dans l'URL
const commandId = getParameterByName('id');

// Récupérer la liste des commandes depuis localStorage
const existingCommands = JSON.parse(localStorage.getItem("commands")) || [];

// Afficher les détails de la commande sélectionnée
// Afficher les détails de la commande sélectionnée
function displayCommandDetails() {
    const commandIndex = parseInt(commandId, 10);
    if (!isNaN(commandIndex) && existingCommands[commandIndex]) {
        const command = existingCommands[commandIndex];
        // document.getElementById("dateCommandDetail").innerText = `Date: ${command.dateCommand || "Non disponible"}`;
        document.getElementById("dateCommandDetail").innerHTML = `<span style="color: red;">Doit à:</span> ${command.dateCommand || "Non disponible"}`;

        document.getElementById("numBonCommandDetail").innerText = `Numéro de bon: ${command.numBonCommand || "Non disponible"}`;
        document.getElementById("doitCommandDetail").innerText = `Doit: ${command.doitCommand || "Non disponible"}`;
        document.getElementById("addresCommandDetail").innerText = `Adresse: ${command.addresCommand || "Non disponible"}`;

        const temporaryCommandsDetail = document.getElementById("temporaryCommandsDetail");
        temporaryCommandsDetail.innerHTML = "";

        if (Array.isArray(command.temporaryCommands)) {
            command.temporaryCommands.forEach((item, index) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td style="text-align: center;">${item.designCommand || "Non disponible"}</td>
                    <td style="text-align: center;">${item.quantite || "Non disponible"}</td>
                    <td style="text-align: center;">${item.uniteCommand || "Non disponible"}</td>
                    ${index === 0 ? `<td style="text-align: center;" rowspan="${command.temporaryCommands.length}">${command.observations || ""}</td>` : ""}
                `;
                // Ajout d'un événement de clic pour ouvrir la fenêtre modale
                row.addEventListener("click", () => openModal(item, command));
                temporaryCommandsDetail.appendChild(row);
            });
        }
    } else {
        alert("Commande non trouvée");
    }
}
// openModal pour ouvrir la fenêtre modale et préremplir les champs
function openModal(item, command) {
    // Préremplir les champs de la fenêtre modale
    document.getElementById("editDesignation").value = item.designCommand || "";
    document.getElementById("editQuantity").value = item.quantite || "";
    document.getElementById("editUnit").value = item.uniteCommand || "";

    document.getElementById("editDoit").value = command.doitCommand || "";
    document.getElementById("editAddress").value = command.addresCommand || "";
    document.getElementById("editNumBon").value = command.numBonCommand || "";

    // Afficher la fenêtre modale
    document.getElementById("editModal").style.display = "block";

    // Sauvegarder l'item sélectionné pour une mise à jour ultérieure
    selectedItem = item;
    selectedCommand = command;
}

// ::saveChanges pour sauvegarder les changements et mettre à jour l'affichage.
function saveChanges() {
    // Mettre à jour les informations de l'item et de la commande sélectionnée
    selectedItem.designCommand = document.getElementById("editDesignation").value;
    selectedItem.quantite = document.getElementById("editQuantity").value;
    selectedItem.uniteCommand = document.getElementById("editUnit").value;

    selectedCommand.doitCommand = document.getElementById("editDoit").value;
    selectedCommand.addresCommand = document.getElementById("editAddress").value;
    selectedCommand.numBonCommand = document.getElementById("editNumBon").value;

    // Sauvegarder les données mises à jour dans localStorage
    localStorage.setItem("commands", JSON.stringify(existingCommands));

    // Fermer la fenêtre modale et rafraîchir les détails de la commande
    closeModal();
    displayCommandDetails();
}

function closeModal() {
    document.getElementById("editModal").style.display = "none";
}


// :::Pour afficher, fermer et supprimer
function confirmDelete() {
    // Ouvrir la fenêtre de confirmation de suppression
    document.getElementById("confirmDeleteModal").style.display = "block";
}

function closeConfirmDeleteModal() {
    // Fermer la fenêtre de confirmation de suppression
    document.getElementById("confirmDeleteModal").style.display = "none";
}

function deleteRow() {
    // Trouver l'index de l'item sélectionné dans la commande
    const commandIndex = existingCommands.findIndex(cmd => cmd === selectedCommand);
    if (commandIndex > -1) {
        const itemIndex = selectedCommand.temporaryCommands.findIndex(item => item === selectedItem);
        
        if (itemIndex > -1) {
            // Supprimer l'item sélectionné
            selectedCommand.temporaryCommands.splice(itemIndex, 1);
            
            // Sauvegarder les données mises à jour dans localStorage
            localStorage.setItem("commands", JSON.stringify(existingCommands));

            // Fermer les fenêtres modales
            closeConfirmDeleteModal();
            closeModal();

            // Rafraîchir les détails de la commande
            displayCommandDetails();
        }
    }
}



// Appeler la fonction pour afficher les détails
// window.onload = displayCommandDetails;


// :::::::::::::::::::::::::::::::::::::::::::
// ::::::TELECHARGEMENT1::::::::::::::::
// :::::::PDF TELECHARGEMENT/////////

// Initialisation des dépendances pour html2canvas et jsPDF
window.html2canvas = html2canvas;
    window.jsPDF = window.jspdf.jsPDF;

    // Fonction makePDF pour capturer et sauvegarder en PDF
   // Fonction makePDF pour capturer et sauvegarder en PDF
   function makePDF() {
    const pdf = new jsPDF("p", "mm", "a4");
    const container = document.querySelector(".container");

    // Ajout de la classe pour le style PDF
    container.classList.add("pdf-style");

    html2canvas(container, {
        allowTaint: true,
        useCORS: true,
        scale: 1
    }).then(canvas => {
        const imgData = canvas.toDataURL("image/png");

        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = pdf.internal.pageSize.getHeight();

        const imgWidth = pdfWidth;
        const imgHeight = (canvas.height * pdfWidth) / canvas.width;

        // Ajouter l'image du contenu principal au PDF
        pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);

        // Texte de la section "accordrecept" à ajouter avant le footer
        const accordeReceptContent = {
            left: "Pour Récéption",
            right: "Le Fournisseur"
        };

        pdf.setFontSize(12);
        pdf.setTextColor(0, 0, 0);
        
        // Position de la section accordeRecept, 47 pixels au-dessus du footer (environ 77 pixels au-dessus de la fin de la page)
        let accordeReceptYPosition = pdfHeight - 87; // Ajusté pour une position plus haute

        // Alignement à gauche et à droite
        pdf.text(accordeReceptContent.left, 15, accordeReceptYPosition); // Gauche
        pdf.text(accordeReceptContent.right, pdfWidth - 45, accordeReceptYPosition); // Droite

        // Contenu du footer (sans image)
        const footerContent = [
            { text: "Direction Generale:", color: [255, 0, 0], xPosition: 35 }, // "Direction Generale" en rouge
            { text: " Bamako-Mali- Hamdallaye ACI 2000 Immeuble ABK-6 B103", color: [0, 0, 0], xPosition: 35 }, // Le reste en bleu
            { text: "Tél: +223 76 02 34 71 6 66 02 34 71 - 61 96 17 94 - 20 74 04 48 / E-mail: ", color: [0, 0, 0] },
            { text: "sankoreservices@gmail.com - www.sankoreservices.com - sankoreservices@yahoo.fr", color: [0, 0, 255] },
            { text: "Bureau de Mopti-Sévaré:", color: [255, 0, 0], xPosition: 35 },
            { text: " Socoura en face de l'IFP de Sévaré", color: [0, 0, 255] },
            { text: "Tél: +223 91 00 00 47 - 91 00 00 48 - 20 29 17 14 - 21 42 19 17", color: [0, 0, 255] },
            { text: "Bureau de Tombouctou:", color: [15, 146, 85], xPosition: 35 }, 
            { text: "Sareikeina Albamé-Derrière la Mairie de Tbt-tel: 66 69 55 92", color: [0, 0, 0] },
            { text: "Bureau de Gao:", color: [255, 0, 0], xPosition: 35 }, 
            { text: "Aldjanabandia-4ème Quartier à coté de la Mare - Tél: 76 18 43 97", color: [15, 146, 85] },
            { text: "NINA: 42009194223006T - RCCM: MA.BKO. 2020.B B5. DU 03/01/2020 - NIF: 082247104J", color: [0, 0, 0] }
        ];

        // Paramètres pour le footer
        pdf.setFontSize(10);
        let yPosition = pdfHeight - 42; // Décalage de 2 pixels vers le haut (pdfHeight - 40 - 2)

        // Dimensions du footer
        const footerHeight = 45; // Hauteur totale du footer
        const footerMargin = 10; // Marge horizontale de chaque côté

        // Dessiner la bordure autour du footer
        pdf.setDrawColor(0, 0, 255);
        pdf.setLineWidth(0.5);
        pdf.rect(footerMargin, pdfHeight - footerHeight - 2, pdfWidth - 2 * footerMargin, footerHeight, "S"); // Décalage de 2 pixels vers le haut

        // Ajouter "Direction Generale:" en rouge puis le reste en bleu sur la même ligne
        pdf.setTextColor(255, 0, 0); // Rouge pour "Direction Generale:"
        pdf.text(footerContent[0].text, footerContent[0].xPosition, yPosition); // "Direction Generale:"
        
        pdf.setTextColor(0, 0, 255); // Bleu pour le reste
        pdf.text(footerContent[1].text, footerContent[1].xPosition, yPosition); // Le reste du texte après "Direction Generale:"

        // Ajouter chaque ligne restante du footer, centrée
        footerContent.slice(2).forEach(line => {
            pdf.setTextColor(...line.color);
            const textWidth = pdf.getTextWidth(line.text); // Calcul de la largeur du texte
            const centeredX = (pdfWidth - textWidth) / 2; // Calcul pour centrer le texte
            pdf.text(line.text, centeredX, yPosition + 5); // Espace entre les lignes
            yPosition += 5; // Espace entre les lignes
        });

        // Enregistrer le PDF
        pdf.save("document.pdf");
    });
}



    // Affichage des détails de commande, avec vérification
    function displayCommandDetails() {
        const commandId = getParameterByName('id');
        const existingCommands = JSON.parse(localStorage.getItem("commands")) || [];
        const commandIndex = parseInt(commandId, 10);

        if (!isNaN(commandIndex) && existingCommands[commandIndex]) {
            const command = existingCommands[commandIndex];
            document.getElementById("dateCommandDetail").innerText = `DATE: ${command.dateCommand || "Non disponible"}`;
            document.getElementById("numBonCommandDetail").innerText = `BON DE LIVRAISON: ${command.numBonCommand || "Non disponible"}`;
            document.getElementById("doitCommandDetail").innerText = `Doit à: ${command.doitCommand || "Non disponible"}`;
            document.getElementById("addresCommandDetail").innerText = ` ${command.addresCommand || "Non disponible"}`;

            const temporaryCommandsDetail = document.getElementById("temporaryCommandsDetail");
            temporaryCommandsDetail.innerHTML = "";

            if (Array.isArray(command.temporaryCommands)) {
                command.temporaryCommands.forEach((item, index) => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td style="text-align: center;">${item.designCommand || "Non disponible"}</td>
                        <td style="text-align: center;">${item.quantite || "Non disponible"}</td>
                        <td style="text-align: center;">${item.uniteCommand || "Non disponible"}</td>
                        ${index === 0 ? `<td style="text-align: center;" rowspan="${command.temporaryCommands.length}">${command.observations || ""}</td>` : ""}
                    `;
                    row.addEventListener("click", () => openModal(item, command));
                    temporaryCommandsDetail.appendChild(row);
                });
            }
        } else {
            alert("Commande non trouvée");
        }
    }

    // Initialisation au chargement
    window.onload = displayCommandDetails;

// Transformation en image
// window.html2canvas = html2canvas;
// window.jsPDF = window.jspdf.jsPDF;

// function makePDF() {
//   html2canvas(document.querySelector("#capture"), {
//     allowTaint: true,
//     useCORS: true,
//     scale: 1
//   }).then(canvas => {
//     var img = canvas.toDataURL("image/png");

//     var doc = new jsPDF();
//     doc.setFont('Arial');
//     doc.save("plomberie.pdf");
//   });
// }

// function downloadPDF() {
//   var element = document.querySelector(".telechargerpdf");
//   html2canvas(element, {
//     scale: 2,
//     scrollX: 0,
//     scrollY: 0,
//     windowWidth: document.documentElement.offsetWidth,
//     windowHeight: document.documentElement.offsetHeight,
//     useCORS: true
//   }).then(function (canvas) {
//     var imgData = canvas.toDataURL("image/png", 1.0);
//     var pdf = new jsPDF("p", "mm", "a4", true);
//     var width = pdf.internal.pageSize.getWidth();
//     var height = pdf.internal.pageSize.getHeight();

//     pdf.addImage(imgData, "PNG", 0, 0, width, height);
//     pdf.save("plomberie.pdf");
//   });
// }
// document.getElementById("telecharger").addEventListener("click", function () {
//   downloadPDF();
// });         
 
</script>